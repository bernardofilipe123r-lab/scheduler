# Content DNA — Full Implementation Prompt

## Context: What This App Is

This is an autonomous multi-brand social content engine. A user (e.g. "Mark") registers, creates N brands (e.g. 5 Instagram Finance accounts), and the system generates:

- **Reels** (light mode: solid brand-color background + text; dark mode: AI-generated image background + dark overlay + text)
- **Carousels / Posts** (AI-generated image + Konva-rendered slides with study DOI + caption)
- **YouTube Shorts** (same video as reel + YT-optimized title)
- **Instagram Captions** with hashtags, CTA, follow/save sections

Content is generated by **DeepSeek** using prompt templates. Backgrounds are generated by **deAPI** (Flux1schnell / ZImageTurbo). The system supports multiple users with different niches. Content DNA is defined per-user and per-brand via a `NicheConfig` table in Supabase/PostgreSQL.

### The PromptContext pipeline (correct design, partially broken execution)

```
NicheConfig (DB)
    └── NicheConfigService.get_context(user_id, brand_id)
            └── PromptContext (dataclass with all niche fields)
                    ├── build_system_prompt(ctx)        → DeepSeek system prompt
                    ├── build_runtime_prompt(ctx)        → DeepSeek per-request prompt
                    ├── build_post_content_prompt(ctx)   → DeepSeek carousel prompt
                    ├── generate_background(ctx)         → deAPI image prompt  ← BROKEN: ctx not passed
                    └── generate_caption(ctx)            → DeepSeek caption    ← PARTIALLY BROKEN
```

---

## The Problem: 7 Specific Broken Locations

The NicheConfig → PromptContext architecture is correct and 70% implemented. However, the following 7 locations still contain hardcoded health/wellness content that ignores the user's Content DNA. A Finance user (Mark) would get:

- ✅ Finance-themed **reel text** (DeepSeek prompts work)
- ❌ **Yoga mats and dumbbells** in his dark-mode reel backgrounds (deAPI ignores ctx)
- ❌ **"Metabolism, organs, brain chemistry"** in his carousel captions (prompt_templates.py)
- ❌ **"Learn more about your health"** on slide 4 of his carousels (prompt_templates.py)
- ❌ **"Wellness still life with natural ingredients"** fallback for post backgrounds (ai_background.py)
- ❌ **@drericberg and #healthyaging** as trending intelligence (trend_scout.py)

---

## Broken Location 1 — `app/services/media/ai_background.py`

### What's wrong

`generate_background()` (line 167) does not accept a `PromptContext` parameter. The subject matter
for the deAPI prompt is hardcoded with health/wellness objects.

**Line 205** — `base_style` string contains "Fresh, clean, healthy, optimistic, uplifting mood":
```python
base_style = """BRIGHT, COLORFUL, VIBRANT still-life composition...
Fresh, clean, healthy, optimistic, uplifting mood..."""
```

**Lines 208–212** — When `content_context` exists:
```python
subject_matter = f"Visual elements inspired by: '{content_context}'. Include relevant
health/wellness objects: water bottles, fresh fruits, vegetables, fitness equipment,
leaves, citrus slices, herbs, supplements, dumbbells, yoga mats, sneakers, salads,
smoothies, clocks, measuring tape - whatever relates to the theme."
```
When no `content_context` (fallback):
```python
subject_matter = "Include an abundance of health and wellness objects: glass water
bottles, fresh fruits, colorful vegetables, green leaves, citrus slices, sneakers,
dumbbells, yoga accessories, clocks, fresh salads, smoothie glasses, measuring tape,
supplements."
```

**Line 435** — Post background fallback:
```python
prompt = user_prompt or "Soft cinematic wellness still life with natural ingredients
on white countertop in morning light."
```

### Why it matters

Every dark-mode reel AND every YouTube thumbnail for a Finance user shows gym/health imagery. The image is the first thing viewers see — wrong imagery = wrong niche signal on every post.

### The Fix

1. Add `ctx: Optional[PromptContext] = None` parameter to `generate_background()` (line 167).
2. Replace the hardcoded `subject_matter` block (lines 208–212) with logic that reads from `ctx`:

```python
from app.core.prompt_context import PromptContext

def generate_background(self, brand_name: str, user_prompt: str = None,
                        progress_callback=None, content_context: str = None,
                        model_override: str = None,
                        ctx: Optional[PromptContext] = None) -> Image.Image:
    ...
    # Build subject matter from PromptContext when available
    if user_prompt:
        # User-supplied custom prompt — use as-is (no subject injection)
        pass  # handled later in prompt assembly
    elif ctx and ctx.image_style_description:
        # Niche-configured visual style from NicheConfig
        visual_keywords = ""
        if ctx.image_palette_keywords:
            visual_keywords = f" Include visual elements: {', '.join(ctx.image_palette_keywords[:12])}."
        if content_context:
            subject_matter = (
                f"Visual elements inspired by: '{content_context}'. "
                f"{ctx.image_style_description}.{visual_keywords}"
            )
        else:
            subject_matter = f"{ctx.image_style_description}.{visual_keywords}"
    elif content_context:
        # No niche config — derive from content text, no niche-specific objects
        subject_matter = (
            f"Visual elements inspired by: '{content_context}'. "
            f"Premium lifestyle photography with objects that match the theme. "
            f"Clean, modern, high-quality composition."
        )
    else:
        # Generic fallback — completely niche-agnostic
        subject_matter = (
            "Premium lifestyle still-life composition with elegant objects "
            "arranged artistically. Clean surfaces, soft lighting, modern aesthetic."
        )
```

3. Remove "Fresh, clean, healthy, optimistic, uplifting mood" from `base_style` (line 205) — replace with "Fresh, clean, premium, optimistic, uplifting mood".

4. Fix the post background fallback (line 435):
```python
# BEFORE:
prompt = user_prompt or "Soft cinematic wellness still life with natural ingredients on white countertop in morning light."

# AFTER:
if not user_prompt:
    if ctx and ctx.image_style_description:
        user_prompt = f"{ctx.image_style_description}. Premium close-up photography style."
    else:
        user_prompt = "Soft cinematic premium still life with elegant objects on a clean surface in morning light."
```

Also add `ctx: Optional[PromptContext] = None` to `generate_post_background()` signature and pass it through.

---

## Broken Location 2 — `app/services/media/image_generator.py`

### What's wrong

`ImageGenerator.__init__()` (line 50) does not store a `PromptContext`. When it calls `AIBackgroundGenerator().generate_background()` (lines 121–126 and 176–181), it never passes context.

### The Fix

1. Add `ctx=None` parameter to `ImageGenerator.__init__()`.
2. Store it as `self.ctx = ctx`.
3. Pass `ctx=self.ctx` in both calls to `generate_background()` and `generate_post_background()`.

```python
# __init__ signature change:
def __init__(self, brand_type, variant: str = "light", brand_name: str = "default",
             ai_prompt: str = None, content_context: str = None,
             image_model: str = None, ctx=None):
    ...
    self.ctx = ctx  # Add this line

# In _get_or_generate_ai_background():
self._ai_background = ai_generator.generate_background(
    self.brand_name,
    self.ai_prompt,
    content_context=content_context,
    model_override=self.image_model,
    ctx=self.ctx,          # ← ADD THIS
)

# In generate_youtube_thumbnail():
image = ai_generator.generate_background(
    self.brand_name,
    self.ai_prompt,
    content_context=content_context,
    model_override=self.image_model,
    ctx=self.ctx,          # ← ADD THIS
)
```

---

## Broken Location 3 — `app/services/content/job_processor.py`

### What's wrong

`ctx` is loaded at line 131–132 for each brand:
```python
ctx = NicheConfigService().get_context(brand_id=brand, user_id=user_id)
```

But when `ImageGenerator` is created at line 164–170, `ctx` is NOT passed:
```python
generator = ImageGenerator(
    brand_type=brand_type,
    variant=job.variant,
    brand_name=brand,
    ai_prompt=job.ai_prompt,
    image_model=getattr(job, 'image_model', None)
    # ← ctx is missing here
)
```

### The Fix

Pass `ctx` to `ImageGenerator`:
```python
generator = ImageGenerator(
    brand_type=brand_type,
    variant=job.variant,
    brand_name=brand,
    ai_prompt=job.ai_prompt,
    image_model=getattr(job, 'image_model', None),
    ctx=ctx,               # ← ADD THIS
)
```

This single-line change threads the NicheConfig context all the way through to deAPI.

---

## Broken Location 4 — `app/core/prompt_templates.py` (Post carousel caption instructions)

### What's wrong

**Lines 506–509** — The carousel caption generation instructions tell DeepSeek to write about body/wellness regardless of niche:
```python
"- Paragraph 2-3: Explain the science/mechanism in accessible, wellness-friendly language."
"Be specific about what happens in the body (metabolism, organs, brain chemistry, skin, energy, etc.)"
```

A Finance user's carousel captions will mention "metabolism, organs, and brain chemistry" because DeepSeek follows these instructions literally.

### The Fix

Replace the hardcoded wellness framing with dynamic niche-aware instructions. The `build_post_content_prompt()` function already receives `ctx`. Use it:

```python
# BEFORE (lines 506-509):
"- Paragraph 2-3: Explain the science/mechanism in accessible, wellness-friendly language. "
"Be specific about what happens in the body (metabolism, organs, brain chemistry, skin, energy, etc.)"

# AFTER:
niche_mechanism = ctx.niche_description if ctx.niche_description else "the core mechanism or process"
mechanism_instruction = (
    f"- Paragraph 2-3: Explain the core mechanism in accessible, {ctx.niche_name.lower() if ctx.niche_name else 'straightforward'} language. "
    f"Be specific about how and why this works within the context of {niche_mechanism}."
)
```

Then use `mechanism_instruction` in the prompt f-string instead of the hardcoded text.

---

## Broken Location 5 — `app/core/prompt_templates.py` (Slide 4 CTA topic words)

### What's wrong

**Line 530** — The instruction for slide 4 contains hardcoded health topic words as examples:
```python
"- Slide 4 text (optional): Closing takeaway + call-to-action. MUST end with a new paragraph: "
"\"Follow @{{{{brandhandle}}}} to learn more about your {{{{topic_word}}}}.\" "
"where topic_word is one relevant word like \"health\", \"brain\", \"body\", "
"\"longevity\", \"energy\", \"skin\", \"sleep\", \"nutrition\" etc."
```

DeepSeek uses these examples literally. A Finance user gets "learn more about your health."

**Line 572** — JSON output template has "your health" hardcoded:
```python
"Fourth slide with closing takeaway.\\n\\nFollow @{{{{brandhandle}}}} to learn more about your health."
```

### The Fix

Replace with niche-derived topic words from `ctx.topic_keywords`. In `build_post_content_prompt()`:

```python
# Build topic word example from ctx.topic_keywords (first 5), or use generic fallback
if ctx.topic_keywords:
    example_topic_words = '", "'.join(ctx.topic_keywords[:5])
    topic_word_instruction = (
        f"where topic_word is one relevant word from your niche, such as "
        f'"{example_topic_words}" etc.'
    )
    # Use first topic keyword as default in the JSON example
    json_example_topic = ctx.topic_keywords[0] if ctx.topic_keywords else "topic"
else:
    topic_word_instruction = (
        "where topic_word is one relevant word that describes the core subject of this post."
    )
    json_example_topic = "this topic"

# Then use these variables in the prompt string instead of hardcoded values
```

In the prompt string at line 530:
```python
f"- Slide 4 text (optional): Closing takeaway + call-to-action. MUST end with a new paragraph: "
f"\"Follow @{{{{brandhandle}}}} to learn more about your {{{{topic_word}}}}.\" "
f"{topic_word_instruction}"
```

In the JSON template at line 572:
```python
f"\"Fourth slide with closing takeaway.\\n\\nFollow @{{{{{{{{brandhandle}}}}}}}} "
f"to learn more about your {json_example_topic}.\""
```

---

## Broken Location 6 — `app/services/analytics/trend_scout.py`

### What's wrong

**Lines 44–50** — `DEFAULT_HASHTAGS` is a hardcoded list of 12 health hashtags:
```python
DEFAULT_HASHTAGS = ["healthyaging", "over40health", "wellnessover50", "womenshealth",
                    "naturalhealth", "healthyliving", "holistichealth", "antiaging",
                    "longevity", "healthtips", "wellnesstips", "guthealth"]
```

**Lines 54–110** — `DEFAULT_COMPETITORS` and `DEFAULT_POST_COMPETITORS` are hardcoded lists of 32 health/wellness Instagram accounts (drericberg, longevityxlab, seedoilscout, etc.)

For a Finance user, the TrendScout scans completely irrelevant accounts and hashtags. All trending intelligence is useless — worse than useless, it wastes API calls.

### The Fix

**Step 1:** Add two new fields to the `NicheConfig` model (`app/models/niche_config.py`):
```python
# Trend Intelligence — empty by default, user fills in their niche's competitors/hashtags
competitor_accounts = Column(JSONB, default=[])       # ["@account1", "@account2", ...]
discovery_hashtags = Column(JSONB, default=[])         # ["hashtag1", "hashtag2", ...]  (no #)
```

**Step 2:** Add these fields to `NicheConfigService._apply_config()` field_map:
```python
'competitor_accounts': 'competitor_accounts',
'discovery_hashtags': 'discovery_hashtags',
```

**Step 3:** Add these fields to `PromptContext`:
```python
competitor_accounts: List[str] = field(default_factory=list)
discovery_hashtags: List[str] = field(default_factory=list)
```

**Step 4:** Modify `TrendScout` to load from NicheConfig per user instead of global defaults:
```python
def _get_hashtags(self, user_id: str = None) -> List[str]:
    """Load hashtags from user's NicheConfig, fall back to empty."""
    if user_id:
        try:
            from app.services.content.niche_config_service import get_niche_config_service
            ctx = get_niche_config_service().get_context(user_id=user_id)
            if ctx.discovery_hashtags:
                return ctx.discovery_hashtags
        except Exception:
            pass
    return []  # No default health hashtags

def _get_competitor_accounts(self, user_id: str = None) -> List[str]:
    """Load competitor accounts from user's NicheConfig, fall back to empty."""
    if user_id:
        try:
            from app.services.content.niche_config_service import get_niche_config_service
            ctx = get_niche_config_service().get_context(user_id=user_id)
            if ctx.competitor_accounts:
                return ctx.competitor_accounts
        except Exception:
            pass
    return []  # No default health competitors
```

Remove the `DEFAULT_HASHTAGS`, `DEFAULT_COMPETITORS`, and `DEFAULT_POST_COMPETITORS` constants entirely. All TrendScout methods that currently use them should call `_get_hashtags(user_id)` and `_get_competitor_accounts(user_id)` instead.

**Step 5:** Add a DB migration to add the new columns:
```sql
ALTER TABLE niche_config ADD COLUMN IF NOT EXISTS competitor_accounts JSONB DEFAULT '[]';
ALTER TABLE niche_config ADD COLUMN IF NOT EXISTS discovery_hashtags JSONB DEFAULT '[]';
```

Add this migration to `run_migrations()` in `app/db_connection.py`.

---

## Broken Location 7 — `app/services/brands/manager.py` (Default seed brands)

### What's wrong

**Lines 138–184** — `DEFAULT_BRANDS` and `DEFAULT_BRAND_COLORS` contain 5 hardcoded health brands:
"THE HEALTHY COLLEGE", "THE LONGEVITY COLLEGE", "THE VITALITY COLLEGE", "THE HOLISTIC COLLEGE", "THE WELLBEING COLLEGE".

When a new user registers and the DB is empty, these 5 health brands are auto-seeded. A Finance user sees health brands as their starting point, which is confusing and wrong.

### The Fix

**Option A (recommended):** Make `seed_default_brands()` a no-op — don't seed anything on a fresh install. A user's first action should be creating their own brand via the UI.

```python
def seed_default_brands(self, user_id: Optional[str] = None) -> int:
    """
    Legacy method — no longer seeds health-specific brands.
    Users create their own brands via the Create Brand UI.
    """
    logger.info("Brand seeding skipped — users create their own brands")
    return 0
```

Remove `DEFAULT_BRANDS` and `DEFAULT_BRAND_COLORS` dictionaries entirely.

**Option B (if an empty state is a UX problem):** Seed ONE completely generic placeholder brand:
```python
DEFAULT_BRANDS = {
    "mybrand": {
        "display_name": "MY BRAND",
        "short_name": "MB",
        "instagram_handle": "@mybrand",
        "facebook_page_name": "My Brand",
        "youtube_channel_name": "My Brand",
        "posts_per_day": 6,
        "baseline_for_content": True,
    }
}
DEFAULT_BRAND_COLORS = {
    "mybrand": {
        "primary": "#6366f1",
        "accent": "#818cf8",
        "color_name": "indigo",
        ...
    }
}
```

---

## Summary of All Changes Required

| Priority | File | Change |
|---|---|---|
| **P0** | `app/services/media/ai_background.py` | Add `ctx` param to `generate_background()` and `generate_post_background()`. Replace hardcoded health subject matter with `ctx.image_style_description` + `ctx.image_palette_keywords`. Fix wellness fallback prompt. |
| **P0** | `app/services/media/image_generator.py` | Add `ctx=None` to `__init__`. Pass `ctx=self.ctx` to all `generate_background()` calls. |
| **P0** | `app/services/content/job_processor.py` | Pass `ctx=ctx` when constructing `ImageGenerator` (1 line). |
| **P0** | `app/core/prompt_templates.py` | Replace hardcoded wellness caption instructions (line 506–509) with niche-dynamic text. Replace hardcoded health topic words (line 530) with `ctx.topic_keywords`. Replace "your health" JSON example (line 572). |
| **P1** | `app/models/niche_config.py` | Add `competitor_accounts` and `discovery_hashtags` JSONB fields. |
| **P1** | `app/core/prompt_context.py` | Add `competitor_accounts` and `discovery_hashtags` list fields. |
| **P1** | `app/services/content/niche_config_service.py` | Add new fields to `field_map` in `_apply_config()`. |
| **P1** | `app/services/analytics/trend_scout.py` | Remove all health defaults. Load hashtags/competitors from NicheConfig per user. |
| **P1** | `app/db_connection.py` | Add migration for new niche_config columns. |
| **P2** | `app/services/brands/manager.py` | Remove health-specific DEFAULT_BRANDS. Make seeding a no-op or use a generic placeholder. |

---

## Validation Checklist

After implementing all changes, validate with this end-to-end test scenario:

**Setup:**
1. Create a test user with NicheConfig:
   - `niche_name` = "Personal Finance"
   - `topic_categories` = ["Investing", "Budgeting", "Stock Market", "Passive Income", "Debt Freedom"]
   - `topic_keywords` = ["money", "investing", "stocks", "portfolio", "wealth", "income"]
   - `image_style_description` = "Clean, modern financial photography with charts, currency, laptops, business attire, city skylines, trading screens"
   - `image_palette_keywords` = ["charts", "dollar bills", "business laptop", "stock ticker", "city skyline", "trading platform", "briefcase", "calculator"]
   - `discovery_hashtags` = ["personalfinance", "investing101", "stockmarket", "financialfreedom"]
   - `competitor_accounts` = ["grahamstephan", "andrei_jikh", "minoritymindset"]
   - `disclaimer_text` = "This content is for educational purposes only and does not constitute financial advice."
   - `cta_options` = [{"text": "Follow for daily finance tips", "weight": 60}, {"text": "Save this for reference", "weight": 40}]

**Test 1 — Dark mode reel:**
- Generate a dark-mode reel for this user's Finance brand
- ✅ PASS: deAPI image shows charts, laptops, business imagery (NOT yoga mats, dumbbells, supplements)
- ✅ PASS: Image prompt sent to deAPI contains words from `image_palette_keywords` like "charts", "trading screens", "briefcase"

**Test 2 — Carousel post:**
- Generate a carousel post in auto mode
- ✅ PASS: Title is about a finance topic (investing, budgeting, etc.)
- ✅ PASS: Caption body mentions finance mechanisms, NOT "metabolism, organs, brain chemistry"
- ✅ PASS: Slide 4 ends with "Follow @brandhandle to learn more about your money/investing" (a keyword from ctx.topic_keywords), NOT "your health"
- ✅ PASS: Caption disclaimer uses the configured financial disclaimer, NOT a wellness disclaimer

**Test 3 — YouTube thumbnail:**
- Check the YouTube thumbnail generated alongside the reel
- ✅ PASS: Thumbnail shows finance-themed imagery (NOT health/wellness)

**Test 4 — Trend scout:**
- Run TrendScout for this user
- ✅ PASS: Scans @grahamstephan, @andrei_jikh, @minoritymindset (configured accounts)
- ✅ PASS: Discovers from #personalfinance, #investing101 (configured hashtags)
- ✅ PASS: Does NOT scan @drericberg or #healthyaging

**Test 5 — Regression: Health niche still works:**
- Create a second user with health niche config
- ✅ PASS: Health user's reels still show health/wellness imagery
- ✅ PASS: Health user's carousels still mention "metabolism, organs, brain chemistry" (via their niche_description)
- ✅ PASS: Finance user is unaffected by Health user's config

---

## Implementation Notes

### Threading of ctx through the call stack

The ctx threading path for dark-mode reel generation is:

```
job_processor.py:131  ctx = NicheConfigService().get_context(brand_id=brand, user_id=user_id)
job_processor.py:164  generator = ImageGenerator(..., ctx=ctx)           ← CHANGE 1 (1 line)
image_generator.py:70  self.ctx = ctx                                    ← CHANGE 2 (1 line in __init__)
image_generator.py:121 ai_generator.generate_background(..., ctx=self.ctx) ← CHANGE 3 (1 line)
ai_background.py:167   generate_background(..., ctx=None)               ← CHANGE 4 (signature + logic)
```

Four files, but three of the four changes are single lines. The complexity lives in `ai_background.py`.

### Niche Config UI reminder

After implementing these backend changes, ensure the NicheConfig frontend form (`src/features/brands/components/NicheConfigForm.tsx` or similar) exposes the new fields:
- `image_style_description` — textarea: "Describe the visual style for your brand's images"
- `image_palette_keywords` — tag input: "Visual objects/elements for AI images (e.g. charts, laptops, trading screens)"
- `competitor_accounts` — tag input: "Competitor/inspiration Instagram accounts to monitor"
- `discovery_hashtags` — tag input: "Hashtags to monitor for trending content"

If these fields are not exposed in the UI, users cannot configure them and the defaults (empty) will be used, resulting in fully generic but niche-agnostic imagery rather than niche-specific imagery.

### What happens when NicheConfig is empty (new user, not configured)

With the fix in place:
- Reel text: "general" topic (PatternSelector falls back to "general" — acceptable)
- Background: Generic "Premium lifestyle still-life composition" (not health, not finance — neutral)
- Caption: Generic mechanism description (not wellness-specific)
- Slide CTA: "learn more about this topic" (neutral)

This is the correct empty-state behavior. Users who fill in NicheConfig get niche-optimized content. Users who don't fill it in get neutral but functional content.
